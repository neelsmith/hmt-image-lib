<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>HMT Image Lib - Interactive Test</title>
    <script src="hmt-iiif-lib.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; display: flex; gap: 20px;}
        .controls { width: 300px; }
        .viewer-container {
            width: 800px;
            height: 600px;
            border: 1px solid #ccc;
            overflow: hidden;
        }
        textarea, pre { width: 100%; box-sizing: border-box; min-height: 100px; font-size: 0.9em; }
        label { display: block; margin-bottom: 5px; }
        input[type="text"] { width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        button { margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="controls">
        <h1>HMT Image Library - Interactive Test</h1>
        
        <label for="urnInput">Image URN:</label>
        <input type="text" id="urnInput" value="urn:cite2:hmt:vaimg.2017a:VA012RN_0013">
        <button id="loadUrnButton">Load/Update Image</button>

        <p>
            <strong>Rectangle Selection:</strong> Hold <code>Option</code> (or <code>Alt</code>) key, then click and drag on the image.
        </p>
        <label for="selectedRectangles">Selected Rectangles (URNs with ROI):</label>
        <textarea id="selectedRectangles" rows="5" readonly></textarea>

        <p>
            <strong>Query Mode:</strong> Hold <code>Shift</code> key, then click on the image.
        </p>
        <label for="queryResult">Query Result (Rectangles containing click point):</label>
        <pre id="queryResult"></pre>
    </div>

    <div id="interactiveViewer" class="viewer-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const urnInput = document.getElementById('urnInput');
            const loadUrnButton = document.getElementById('loadUrnButton');
            const selectedRectanglesTextarea = document.getElementById('selectedRectangles');
            const queryResultPre = document.getElementById('queryResult');

            let currentViewer = null;

            function rectangleSelectedListener(urnsWithRoiString) {
                selectedRectanglesTextarea.value = urnsWithRoiString;
            }

            function queryListener(matchingUrnsList) {
                if (matchingUrnsList.length > 0) {
                    queryResultPre.textContent = "Clicked point is within:\n" + matchingUrnsList.join('\n');
                } else {
                    queryResultPre.textContent = "Clicked point is not within any highlighted rectangle.";
                }
            }
            
            function setupViewer(urn) {
                if (currentViewer) {
                    // If you implement a destroy method on the viewer:
                    // currentViewer.destroy(); 
                    // For now, just re-use or re-create
                }
                 // Destroy existing viewer instance if it exists
                if (currentViewer && typeof currentViewer.destroy === 'function') {
                    currentViewer.destroy();
                }
                currentViewer = HMTImageLib.createViewer('interactiveViewer', urn, {
                    rectangleSelectedListener: rectangleSelectedListener,
                    queryListener: queryListener
                });

                // If createViewer fails (e.g. bad URN initially)
                if (!currentViewer && document.getElementById('interactiveViewer').textContent.includes("Error")) {
                    selectedRectanglesTextarea.value = "";
                    queryResultPre.textContent = "";
                }
            }
            
            loadUrnButton.addEventListener('click', () => {
                 // If a viewer exists and has a setUrn method (as added in the JS)
                if (currentViewer && typeof currentViewer.setUrn === 'function') {
                    currentViewer.setUrn(urnInput.value.trim());
                     // Clear outputs as setUrn resets rectangles
                    selectedRectanglesTextarea.value = "";
                    queryResultPre.textContent = "";
                } else { // Otherwise, create a new one
                    setupViewer(urnInput.value.trim());
                }
            });

            // Initial load
            setupViewer(urnInput.value.trim());
        });
    </script>
</body>
</html>